/**
 * -------------------------------------------------------------------------------------------------
 * @author  Ryan Sullivan (ryansullivan@googlemail.com)
 *
 * @file    system.c
 * @brief   Internal configuration functions.
 *
 * @date    2021-07-31
 * -------------------------------------------------------------------------------------------------
 */

#include "types.h"

#include "system.h"

/*------------------------------------------------------------------------------------------------*/
/*-constant-definitions---------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------------------------*/

/*
 * Fuse configuration bytes.
 */
#pragma clang diagnostic ignored "-Wmissing-variable-declarations"

NVM_FUSES_t __fuse
    __attribute__((section(".fuse"))) = { .WDTCFG = WINDOW_OFF_gc | PERIOD_OFF_gc,
                                          .BODCFG = LVL_BODLEVEL0_gc | SAMPFREQ_1KHZ_gc |
                                                    ACTIVE_DIS_gc | SLEEP_DIS_gc,
                                          .OSCCFG  = FREQSEL_20MHZ_gc,
                                          .TCD0CFG = 0,
                                          .SYSCFG0 = CRCSRC_NOCRC_gc | RSTPINCFG_UPDI_gc,
                                          .SYSCFG1 = SUT_1MS_gc,
                                          .APPEND  = 0,
                                          .BOOTEND = 0 };

/*------------------------------------------------------------------------------------------------*/
/*-exported-variables-----------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------------------------*/

/*------------------------------------------------------------------------------------------------*/
/*-static-variables-------------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------------------------*/

/*------------------------------------------------------------------------------------------------*/
/*-forward-declarations---------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------------------------*/

/*------------------------------------------------------------------------------------------------*/
/*-exported-functions-----------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------------------------*/

/**
 * @brief   Initialise the system clocks.
 */
void system_initialise(void)
{
    /*
     * Disable the prescaler to run the main clock at 20MHz.
     * Need to write the correct key to the config change protection register.
     */
     CPU_CCP = CCP_IOREG_gc;
     CLKCTRL.MCLKCTRLB = 0;
}

/*------------------------------------------------------------------------------------------------*/

/**
 * @brief   Initialise TCA as a 1ms timer. ISR in main.
 */
void system_timer_initialise(void)
{
    TCA0.SINGLE.CTRLA = TCA_SINGLE_CLKSEL_DIV1_gc;
    TCA0.SINGLE.CTRLB = TCA_SINGLE_WGMODE_NORMAL_gc;
    TCA0.SINGLE.PER = 20000;

    TCA0.SINGLE.INTCTRL = TCA_SINGLE_OVF_bm;

    TCA0.SINGLE.CTRLA = TCA_SINGLE_ENABLE_bm;


    
}

/*------------------------------------------------------------------------------------------------*/
/*-static-functions-------------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------------------------*/

/*------------------------------------------------------------------------------------------------*/
/*-end-of-module----------------------------------------------------------------------------------*/
/*------------------------------------------------------------------------------------------------*/
